
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Custom Simulator &#8212; TorchSim Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'generated/autoexamples/01-simple-simulator';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Synthetic Data Generation" href="02-synth-data.html" />
    <link rel="prev" title="Examples" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">TorchSim Documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    TorchSim
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Examples</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Custom Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-synth-data.html">Synthetic Data Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-fitting.html">Parameter Fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-derivatives.html">Automatic differentiation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api.html">API References</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.AbstractModel.html">AbstractModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.autocast.html">autocast</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.prepare_environmental_parameters.html">prepare_environmental_parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.prepare_single_pool.html">prepare_single_pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.prepare_two_pool_bm.html">prepare_two_pool_bm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.prepare_two_pool_mt.html">prepare_two_pool_mt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.base.prepare_three_pool.html">prepare_three_pool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.states_matrix.html">states_matrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.get_signal.html">get_signal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.get_demodulated_signal.html">get_demodulated_signal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.rf_pulse_op.html">rf_pulse_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.phased_rf_pulse_op.html">phased_rf_pulse_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.multidrive_rf_pulse_op.html">multidrive_rf_pulse_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.phased_multidrive_rf_pulse_op.html">phased_multidrive_rf_pulse_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.rf_pulse.html">rf_pulse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.initialize_mt_sat.html">initialize_mt_sat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.mt_sat_op.html">mt_sat_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.multidrive_mt_sat_op.html">multidrive_mt_sat_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.mt_sat.html">mt_sat</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.longitudinal_relaxation_op.html">longitudinal_relaxation_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.longitudinal_relaxation.html">longitudinal_relaxation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.longitudinal_relaxation_exchange_op.html">longitudinal_relaxation_exchange_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.longitudinal_relaxation_exchange.html">longitudinal_relaxation_exchange</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.transverse_relaxation_op.html">transverse_relaxation_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.transverse_relaxation.html">transverse_relaxation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.transverse_relaxation_exchange_op.html">transverse_relaxation_exchange_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.transverse_relaxation_exchange.html">transverse_relaxation_exchange</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.shift.html">shift</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.spoil.html">spoil</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.adiabatic_inversion.html">adiabatic_inversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.diffusion_op.html">diffusion_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.diffusion.html">diffusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.flow_op.html">flow_op</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.epg.flow.html">flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.bSSFPModel.html">bSSFPModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.SPGRModel.html">SPGRModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.FSEModel.html">FSEModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.MPRAGEModel.html">MPRAGEModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.MP2RAGEModel.html">MP2RAGEModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.MPnRAGEModel.html">MPnRAGEModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.models.MRFModel.html">MRFModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.bssfp_sim.html">bssfp_sim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.spgr_sim.html">spgr_sim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.utils.b1rms.html">b1rms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchsim.utils.slice_prof.html">slice_prof</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../misc/contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/development.html">Developing TorchSim</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Related Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://github.com/brennerd11/EpyG">epyg</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/lamyj/sycomore/">sycomore</a></li>
<li class="toctree-l1"><a class="reference external" href="https://somnathrakshit.github.io/projects/project-mri-sim-py-epg/">mri-sim-py</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/mckib2/ssfp">ssfp</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/lamyj/erwin">erwin</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/INFN-MRI/torchsim" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/INFN-MRI/torchsim/edit/main/generated/autoexamples/01-simple-simulator.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/INFN-MRI/torchsim/issues/new?title=Issue%20on%20page%20%2Fgenerated/autoexamples/01-simple-simulator.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/generated/autoexamples/01-simple-simulator.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Custom Simulator</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-the-model">Defining the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiating-the-simulator">Instantiating the simulator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-object-properties">Setting object properties</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-sequence-properties">Setting sequence properties</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notes-on-simulation-engine">Notes on simulation engine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-simulation">Running the simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-usage">Advanced Usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#functional-wrappers">Functional Wrappers</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-generated-autoexamples-01-simple-simulator-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code. or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="custom-simulator">
<span id="sphx-glr-generated-autoexamples-01-simple-simulator-py"></span><h1>Custom Simulator<a class="headerlink" href="#custom-simulator" title="Link to this heading">#</a></h1>
<p>This example shows how to use TorchSim to implement a simulator.</p>
<p>First, we want to implement the simulation engine.
Parallelization and automatic differentiation are abstracted
away from the user, which can focus on implementing single-voxel
simulation.</p>
<div class="colab-button">
            <a href="https://colab.research.google.com/github/INFN-MRI/torchsim/blob/gh-pages/examples/generated/autoexamples/01-simple-simulator.ipynb" target="_blank">
                <img src="https://colab.research.google.com/assets/colab-badge.svg" 
                alt="Open In Colab"/>
            </a>
        </div>
        <p>We begin with the necessary imports:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<a href="https://docs.python.org/3/library/warnings.html#warnings.filterwarnings" title="warnings.filterwarnings" class="sphx-glr-backref-module-warnings sphx-glr-backref-type-py-function"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span></a><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">torchsim</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">torchsim</span> <span class="kn">import</span> <span class="n">epg</span>
</pre></div>
</div>
<section id="defining-the-model">
<h2>Defining the model<a class="headerlink" href="#defining-the-model" title="Link to this heading">#</a></h2>
<p>The model can be derived by <code class="docutils literal notranslate"><span class="pre">base.AbstractModel</span></code> as:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SSFPMRFModel</span><span class="p">(</span><a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel" title="torchsim.base.AbstractModel" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-class"><span class="n">base</span><span class="o">.</span><span class="n">AbstractModel</span></a><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to simulate inversion-prepared (variable flip angle) SSFP.&quot;&quot;&quot;</span>

    <span class="nd">@base</span><span class="o">.</span><span class="n">autocast</span>
    <span class="k">def</span> <span class="nf">set_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">T1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="n">T2</span>

    <span class="nd">@base</span><span class="o">.</span><span class="n">autocast</span>
    <span class="k">def</span> <span class="nf">set_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="n">TR</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">torch</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a> <span class="o">/</span> <span class="mf">180.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="n">TR</span> <span class="o">*</span> <span class="mf">1e-3</span>  <span class="c1"># ms -&gt; s</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_engine</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="n">TR</span><span class="p">):</span>
        <span class="c1"># Prepare relaxation parameters</span>
        <span class="n">R1</span><span class="p">,</span> <span class="n">R2</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">/</span> <span class="n">T1</span><span class="p">,</span> <span class="mf">1e3</span> <span class="o">/</span> <span class="n">T2</span>

        <span class="c1"># Prepare EPG states matrix</span>
        <span class="n">states</span> <span class="o">=</span> <a href="../torchsim.epg.states_matrix.html#torchsim.epg.states_matrix" title="torchsim.epg.states_matrix" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">states_matrix</span></a><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">R1</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">nstates</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Prepare relaxation operator for sequence loop</span>
        <span class="n">E1</span><span class="p">,</span> <span class="n">rE1</span> <span class="o">=</span> <a href="../torchsim.epg.longitudinal_relaxation_op.html#torchsim.epg.longitudinal_relaxation_op" title="torchsim.epg.longitudinal_relaxation_op" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">longitudinal_relaxation_op</span></a><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">TR</span><span class="p">)</span>
        <span class="n">E2</span> <span class="o">=</span> <a href="../torchsim.epg.transverse_relaxation_op.html#torchsim.epg.transverse_relaxation_op" title="torchsim.epg.transverse_relaxation_op" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">transverse_relaxation_op</span></a><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">TR</span><span class="p">)</span>

        <span class="c1"># Get number of shots</span>
        <span class="n">nshots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">)</span>

        <span class="c1"># Initialize signal</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Apply inversion</span>
        <span class="n">states</span> <span class="o">=</span> <a href="../torchsim.epg.adiabatic_inversion.html#torchsim.epg.adiabatic_inversion" title="torchsim.epg.adiabatic_inversion" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">adiabatic_inversion</span></a><span class="p">(</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># Scan loop</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nshots</span><span class="p">):</span>
            <span class="n">RF</span> <span class="o">=</span> <a href="../torchsim.epg.rf_pulse_op.html#torchsim.epg.rf_pulse_op" title="torchsim.epg.rf_pulse_op" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">rf_pulse_op</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">[</span><span class="n">p</span><span class="p">])</span>

            <span class="c1"># Apply RF pulse</span>
            <span class="n">states</span> <span class="o">=</span> <a href="../torchsim.epg.rf_pulse.html#torchsim.epg.rf_pulse" title="torchsim.epg.rf_pulse" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">rf_pulse</span></a><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">RF</span><span class="p">)</span>

            <span class="c1"># Record signal</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="../torchsim.epg.get_signal.html#torchsim.epg.get_signal" title="torchsim.epg.get_signal" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">get_signal</span></a><span class="p">(</span><span class="n">states</span><span class="p">))</span>

            <span class="c1"># Evolve</span>
            <span class="n">states</span> <span class="o">=</span> <a href="../torchsim.epg.longitudinal_relaxation.html#torchsim.epg.longitudinal_relaxation" title="torchsim.epg.longitudinal_relaxation" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">longitudinal_relaxation</span></a><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">E1</span><span class="p">,</span> <span class="n">rE1</span><span class="p">)</span>
            <span class="n">states</span> <span class="o">=</span> <a href="../torchsim.epg.transverse_relaxation.html#torchsim.epg.transverse_relaxation" title="torchsim.epg.transverse_relaxation" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">transverse_relaxation</span></a><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">E2</span><span class="p">)</span>
            <span class="n">states</span> <span class="o">=</span> <a href="../torchsim.epg.shift.html#torchsim.epg.shift" title="torchsim.epg.shift" class="sphx-glr-backref-module-torchsim-epg sphx-glr-backref-type-py-function"><span class="n">epg</span><span class="o">.</span><span class="n">shift</span></a><span class="p">(</span><span class="n">states</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
</pre></div>
</div>
<p>With this definition, the simulator can be used as follows.</p>
</section>
<section id="instantiating-the-simulator">
<h2>Instantiating the simulator<a class="headerlink" href="#instantiating-the-simulator" title="Link to this heading">#</a></h2>
<p>The simulator is derived from base class.
Base constructor accept the following parameters:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">diff</span></code>: this is either a string or a tuple of strings containing the name of the parameter we want to calculate the derivatives (e.g., <code class="docutils literal notranslate"><span class="pre">&quot;T1&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">(&quot;T1&quot;,</span> <span class="pre">&quot;T2&quot;)</span></code>).
If not provided, simulator only computes the forward pass.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>: computation is vectorized in batches of size <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>. The larger, the
faster the computation is, but at expense of increased memory usage. At the moment, it must
be tuned manually by the user. If not provided, attempt to process the whole batch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">device</span></code>: computational device of choice. If not provided, it is inferred from inputs (more later).</p></li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel" title="torchsim.base.AbstractModel" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-class"><span class="n">SSFPMRFModel</span></a><span class="p">(</span><span class="n">diff</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">))</span>  <span class="c1"># we use the defaults here</span>
</pre></div>
</div>
</section>
<section id="setting-object-properties">
<h2>Setting object properties<a class="headerlink" href="#setting-object-properties" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">set_properties</span></code> method must contain all the object-dependent parameters (T1, T2, B1, …), which are
automatically broadcasted.</p>
<p>Here, we provide <code class="docutils literal notranslate"><span class="pre">T1</span></code>, <code class="docutils literal notranslate"><span class="pre">T2</span></code>, <code class="docutils literal notranslate"><span class="pre">M0</span></code>. These can be either scalar or array-valued quantities (e.g., for a whole parameter map).
Input will be automatically converted to <code class="docutils literal notranslate"><span class="pre">torch.Tensor</span></code> and moved to the same device as the first argument (<code class="docutils literal notranslate"><span class="pre">T1</span></code>) thanks to <code class="docutils literal notranslate"><span class="pre">base.autocast</span></code> decorator.</p>
<p>In this method, the arguments must be assigned to the <code class="docutils literal notranslate"><span class="pre">properties</span></code> attribute (<code class="docutils literal notranslate"><span class="pre">self.properties</span></code>).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel.set_properties" title="torchsim.base.AbstractModel.set_properties" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">set_properties</span></a><span class="p">(</span><span class="n">T1</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="setting-sequence-properties">
<h2>Setting sequence properties<a class="headerlink" href="#setting-sequence-properties" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">set_sequence</span></code> method must contain all the sequence-depenent parameters, which are
shared amongst all the simulated atoms.</p>
<p>Here, we provide the flip angle schedule and the sequence TR.
Input will be automatically converted to <code class="docutils literal notranslate"><span class="pre">torch.Tensor</span></code> and moved to the same device as the first argument (<code class="docutils literal notranslate"><span class="pre">flip</span></code>) thanks to <code class="docutils literal notranslate"><span class="pre">base.autocast</span></code> decorator.</p>
<p>Other preprocessing such as unit conversions (e.g., <code class="docutils literal notranslate"><span class="pre">deg</span> <span class="pre">to</span> <span class="pre">rad</span></code>) must be performed manually by the user in this function.
After preprocessing, the arguments must be assigned to the <code class="docutils literal notranslate"><span class="pre">sequence</span></code> attribute (<code class="docutils literal notranslate"><span class="pre">self.sequence</span></code>).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.concatenate.html#numpy.concatenate" title="numpy.concatenate" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span></a><span class="p">(</span>
    <span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html#numpy.linspace" title="numpy.linspace" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">linspace</span></a><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mi">350</span><span class="p">),</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html#numpy.linspace" title="numpy.linspace" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">linspace</span></a><span class="p">(</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">350</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">*</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ones.html#numpy.ones" title="numpy.ones" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><span class="mi">180</span><span class="p">))</span>
<span class="p">)</span>
<a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel.set_sequence" title="torchsim.base.AbstractModel.set_sequence" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">set_sequence</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="n">TR</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="notes-on-simulation-engine">
<h2>Notes on simulation engine<a class="headerlink" href="#notes-on-simulation-engine" title="Link to this heading">#</a></h2>
<p>After defining <code class="docutils literal notranslate"><span class="pre">set_properties</span></code> and <code class="docutils literal notranslate"><span class="pre">set_sequence</span></code> The user should implement the actual simulator
by overriding the <code class="docutils literal notranslate"><span class="pre">_engine</span></code> method. This must be decorated as a <code class="docutils literal notranslate"><span class="pre">static_method</span></code> and contain each and exclusively the
parameters defined in <code class="docutils literal notranslate"><span class="pre">set_properties</span></code> and <code class="docutils literal notranslate"><span class="pre">set_sequence</span></code> signature.</p>
<p>For consistent derivative scaling, all unit conversions must be performed in the body of this function.</p>
<p>The user should implement the simulation as it were acting on a single atom (e.g., a single combination of <code class="docutils literal notranslate"><span class="pre">properties</span></code> parameters).
The base class will ensure that all <code class="docutils literal notranslate"><span class="pre">properties</span></code> are broadcasted and computation vectorized over batches of size <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>.</p>
<p>By contrast, <code class="docutils literal notranslate"><span class="pre">sequence</span></code> parameters will not be broadcasted, and are shared amongst all the atoms.</p>
</section>
<section id="running-the-simulation">
<h2>Running the simulation<a class="headerlink" href="#running-the-simulation" title="Link to this heading">#</a></h2>
<p>After object instantiation and definition of object and sequence parameters, simulation can be executed by
using the magic <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">signal</span><span class="p">,</span> <span class="n">derivatives</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
</pre></div>
</div>
<p>When using this method, all the parameters are automatically moved to the device specified
at object construction or, if this is not provided, to the same device as the first
argument of <code class="docutils literal notranslate"><span class="pre">set_properties</span></code> method (here, <code class="docutils literal notranslate"><span class="pre">T1</span></code>).</p>
</section>
<section id="advanced-usage">
<h2>Advanced Usage<a class="headerlink" href="#advanced-usage" title="Link to this heading">#</a></h2>
<p>As an alternative, forward and jacobian callables can be extracted, e.g., to be used with external
packages for parameter fitting, model based reconstruction or sequence optimization.</p>
<p>This can be achieved as</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">forw_fn</span> <span class="o">=</span> <a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel.forward" title="torchsim.base.AbstractModel.forward" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">forward</span></a><span class="p">(</span><span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># compile=True is still experimental</span>
<span class="n">jac_fn</span> <span class="o">=</span> <a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel.jacobian" title="torchsim.base.AbstractModel.jacobian" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">jacobian</span></a><span class="p">(</span><span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>These functions capture all <code class="docutils literal notranslate"><span class="pre">sequence</span></code> parameters, and have the same signature
as <code class="docutils literal notranslate"><span class="pre">set_properties</span></code>, i.e., they accept object parameters as inputs:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">signal</span> <span class="o">=</span> <span class="n">forw_fn</span><span class="p">(</span><span class="n">T1</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
<span class="n">derivatives</span> <span class="o">=</span> <span class="n">jac_fn</span><span class="p">(</span><span class="n">T1</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we use autodifferentiation to compute the jacobian function.
As an alternative, user can specify a manual jacobain function by overriding
the <code class="docutils literal notranslate"><span class="pre">_jacobian_engine</span></code> method. Similarly to the <code class="docutils literal notranslate"><span class="pre">_engine</span></code> method,
this must be a <code class="docutils literal notranslate"><span class="pre">staticmethod</span></code> and contain each and exclusively the
parameters defined in <code class="docutils literal notranslate"><span class="pre">set_properties</span></code> and <code class="docutils literal notranslate"><span class="pre">set_sequence</span></code> signature.</p>
</section>
<section id="functional-wrappers">
<h2>Functional Wrappers<a class="headerlink" href="#functional-wrappers" title="Link to this heading">#</a></h2>
<p>We can wrap the Model class in a function, for user convenience:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mrf_sim</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="n">TR</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate an inversion-prepared SSFP sequence with variable flip angles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flip : array-like</span>
<span class="sd">        Flip angle in [deg] of shape (npulses,).</span>
<span class="sd">    TR: float</span>
<span class="sd">        Repetition time in [ms].</span>
<span class="sd">    T1 : float | array-like</span>
<span class="sd">        Longitudinal relaxation time in [ms].</span>
<span class="sd">    T2 : float | array-like</span>
<span class="sd">        Transverse relaxation time in [ms].</span>
<span class="sd">    diff : str | tuple[str], optional:</span>
<span class="sd">        Arguments to get the signal derivative with respect to.</span>
<span class="sd">        Defaults to None (no differentation).</span>
<span class="sd">    device : str, optional Computational device.</span>
<span class="sd">        Defaults to &quot;cpu&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    signal : torch.Tensor</span>
<span class="sd">        Simulated signal</span>
<span class="sd">    jac : torch.Tensor</span>
<span class="sd">        Partial derivative(s) of simulated signal. Returned</span>
<span class="sd">        only if ``diff`` is not None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize simulator</span>
    <span class="n">model</span> <span class="o">=</span> <a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel" title="torchsim.base.AbstractModel" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-class"><span class="n">SSFPMRFModel</span></a><span class="p">(</span><span class="n">diff</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel.set_properties" title="torchsim.base.AbstractModel.set_properties" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">set_properties</span></a><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
    <a href="../torchsim.base.AbstractModel.html#torchsim.base.AbstractModel.set_sequence" title="torchsim.base.AbstractModel.set_sequence" class="sphx-glr-backref-module-torchsim-base sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">set_sequence</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="n">TR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">()</span>
</pre></div>
</div>
<p>That’s it!
The simulator can be used on single voxel, to quickly predict signal evolution:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">sig</span> <span class="o">=</span> <span class="n">mrf_sim</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>

<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html#matplotlib.pyplot.plot" title="matplotlib.pyplot.plot" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span></a><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.xlabel.html#matplotlib.pyplot.xlabel" title="matplotlib.pyplot.xlabel" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span></a><span class="p">(</span><span class="s2">&quot;TR index&quot;</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.ylabel.html#matplotlib.pyplot.ylabel" title="matplotlib.pyplot.ylabel" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span></a><span class="p">(</span><span class="s2">&quot;signal magnitude [a.u.]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_01-simple-simulator_001.png" srcset="../../_images/sphx_glr_01-simple-simulator_001.png" alt="01 simple simulator" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(33.972222222222214, 0.5, &#39;signal magnitude [a.u.]&#39;)
</pre></div>
</div>
<p>As mentioned, parallelization with automatic broadcasting is supported…</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sig</span> <span class="o">=</span> <span class="n">mrf_sim</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="p">[</span><span class="mf">1000.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">],</span> <span class="mf">100.0</span><span class="p">)</span>

<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html#matplotlib.pyplot.plot" title="matplotlib.pyplot.plot" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span></a><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.xlabel.html#matplotlib.pyplot.xlabel" title="matplotlib.pyplot.xlabel" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span></a><span class="p">(</span><span class="s2">&quot;TR index&quot;</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.ylabel.html#matplotlib.pyplot.ylabel" title="matplotlib.pyplot.ylabel" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span></a><span class="p">(</span><span class="s2">&quot;signal magnitude [a.u.]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_01-simple-simulator_002.png" srcset="../../_images/sphx_glr_01-simple-simulator_002.png" alt="01 simple simulator" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(25.222222222222214, 0.5, &#39;signal magnitude [a.u.]&#39;)
</pre></div>
</div>
<p>…as well as automatic differentiation controlled by <code class="docutils literal notranslate"><span class="pre">diff</span></code> argument:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sig</span><span class="p">,</span> <span class="n">jac</span> <span class="o">=</span> <span class="n">mrf_sim</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">flip</span></a><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">))</span>

<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html#matplotlib.pyplot.plot" title="matplotlib.pyplot.plot" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span></a><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.xlabel.html#matplotlib.pyplot.xlabel" title="matplotlib.pyplot.xlabel" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span></a><span class="p">(</span><span class="s2">&quot;TR index&quot;</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.ylabel.html#matplotlib.pyplot.ylabel" title="matplotlib.pyplot.ylabel" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span></a><span class="p">(</span><span class="s2">&quot;signal jacobian [a.u.]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_01-simple-simulator_003.png" srcset="../../_images/sphx_glr_01-simple-simulator_003.png" alt="01 simple simulator" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Text(16.472222222222214, 0.5, &#39;signal jacobian [a.u.]&#39;)
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 13.508 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-generated-autoexamples-01-simple-simulator-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/infn-mri/torchsim/gh-pages?urlpath=lab/tree/examples/generated/autoexamples/01-simple-simulator.ipynb"><img alt="Launch binder" src="../../_images/binder_badge_logo.svg" style="width: 150px;" />
</a>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/1228c6c4965a45f87770795f8598cc58/01-simple-simulator.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">01-simple-simulator.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/581ddc530446217a0b167fcd18a02be8/01-simple-simulator.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">01-simple-simulator.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/0285254386cfc897e8ef0ee3e3b1cfb2/01-simple-simulator.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">01-simple-simulator.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Examples</p>
      </div>
    </a>
    <a class="right-next"
       href="02-synth-data.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Synthetic Data Generation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-the-model">Defining the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiating-the-simulator">Instantiating the simulator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-object-properties">Setting object properties</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-sequence-properties">Setting sequence properties</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notes-on-simulation-engine">Notes on simulation engine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-simulation">Running the simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-usage">Advanced Usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#functional-wrappers">Functional Wrappers</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By TorchSim Contributors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, TorchSim Contributors.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>